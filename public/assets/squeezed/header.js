(function(){var m=false;var a=function a(){if(m){return false}if(!document.createElement("canvas").getContext){m=true;if(typeof console!=="undefined"){console.log("Notificon: requires canvas support")}return false}return true};var k=function k(n){if(!n){n={}}var p={font:"10px monospace",color:"#000000",stroke:"rgba(255,255,255,0.85)",align:"right",valign:"bottom",width:4,favicon:j()};for(var o in p){if(!n[o]){n[o]=p[o]}}return n};var l=function l(p){var o=document.getElementsByTagName("link");for(var n=0;n<o.length;n++){if(p&&(/\bnotificon\b/i).test(o[n].getAttribute("rel"))){return o[n]}else{if(!p&&(/\bicon\b/i).test(o[n].getAttribute("rel"))){return o[n]}}}return false};var j=function j(){var n=l();return n?n.getAttribute("href"):"/favicon.ico"};var e=function e(){var n=l(true);if(n){n.parentNode.removeChild(n);e()}};var f=function f(o){var n=document.createElement("link");n.type="image/x-icon";n.rel="icon notificon";n.href=o;e();document.getElementsByTagName("head")[0].appendChild(n)};var d=function d(n){return{x:n.align.toLowerCase()==="left"?0:16,y:n.valign.toLowerCase()==="top"?0:18}};var h=function h(p,o,n){var q=p.getContext("2d");var r=d(n);q.font=n.font;q.fillStyle=n.color;q.textAlign=n.align;q.textBaseline=n.valign;q.strokeStyle=n.stroke;q.lineWidth=n.width;q.strokeText(o,r.x,r.y);q.fillText(o,r.x,r.y)};var c=function c(n){var o=document.createElement("canvas");o.width=n.width;o.height=n.height;var p=o.getContext("2d");p.drawImage(n,0,0);return o};var b=function b(q,n){if(!a()){return false}var p=k(n);q=""+q;if(!q.length){return f(p.favicon)}var o=document.createElement("img");o.src=p.favicon;o.crossOrigin="anonymous";o.onload=function(){var r=c(o);if(q){h(r,q,p)}try{return f(r.toDataURL("image/png"))}catch(s){if(typeof console!=="undefined"){console.log("Notificon: cannot use icons located on a different domain ("+favicon+")");return false}}};o.onerror=function(){if(typeof console!=="undefined"){console.log("Notificon: image not found ("+p.favicon+")");return false}};return true};var i=function(o,n){b(o,n)};i.reset=function g(){e()};if(typeof exports!=="undefined"){module.exports=i}else{this.Notificon=i}})(this);(function(f,b){var d,e,c=false,a=function(g){var h=g>d;if(h!==c){f("#barBottomContainer").toggleClass("fixed",h);c=h}};STUDIP.HeaderMagic={enable:function(){var g=f("#barBottomContainer");if(g.closest(".sticky-wrapper").length===0){g.wrap('<div class="sticky-wrapper" />').parent().height(g.outerHeight(true))}d=g.offset().top;STUDIP.Scroll.addHandler("header",a)},disable:function(){STUDIP.Scroll.removeHandler("header");f("#barBottomContainer").removeClass("fixed")}};f(b).ready(function(){if(f("#barBottomContainer").length>0){STUDIP.HeaderMagic.enable()}})}(jQuery,window.document));(function(b){function a(d,f,c){var g=d.getContext("2d"),e=c?f/c:1;g.clearRect(0,0,d.width,d.height);if(f===128&&c===32){g.drawImage(this,0,5,106,28,5,5,28*e,28)}else{g.drawImage(this,14,8,56*e,56)}g.globalCompositeOperation="destination-out";g.beginPath();g.arc(d.width-16,16,22,0,2*Math.PI);g.fill();b(d).closest("a").addClass("canvasready")}b(document).ready(function(){b("html.canvas img.headericon.original").each(function(){var e=b('<canvas width="84" height="64">').addClass("headericon punch").insertAfter(this),f=b(this).width(),c=b(this).height(),d=new Image();d.onload=a.bind(this,e[0],f,c);d.src=this.src})})}(jQuery));(function(e){var a={},d,b,c=false;directlydeleted=[];var f=function(g){var h=e("<ul/>"),j=false,i={};e.each(g,function(k,m){if(e.inArray(m.personal_notification_id,directlydeleted)===-1){h.append(m.html);var n=e(".notification:last",h).data().id;i[n]=m;if(m.html_id){e("#"+m.html_id).bind("mouseenter",STUDIP.PersonalNotifications.isVisited)}j=(j||!(n in a));if(typeof Notification!=="undefined"&&Notification.permission==="granted"){if(typeof sessionStorage!=="undefined"&&!sessionStorage["desktop.notification.exists."+m.id]){var l=new Notification(STUDIP.STUDIP_SHORT_NAME,{body:m.text,icon:m.avatar,tag:m.id});l.addEventListener("click",function(){location.href=STUDIP.ABSOLUTE_URI_STUDIP+"dispatch.php/jsupdater/mark_notification_read/"+this.tag});sessionStorage["desktop.notification.exists."+m.id]=1}}}});if(j||_.values(a).length!==_.values(i).length){a=i;e("#notification_list > ul").replaceWith(h)}STUDIP.PersonalNotifications.update();directlydeleted=[]};STUDIP.PersonalNotifications={newNotifications:function(){},markAsRead:function(g){var h=e(this).closest(".notification"),i=h.data().id;STUDIP.PersonalNotifications.sendReadInfo(i,h);return false},sendReadInfo:function(h,g){e.ajax({url:STUDIP.ABSOLUTE_URI_STUDIP+"dispatch.php/jsupdater/mark_notification_read/"+h,success:function(){if(g){g.toggle("blind","fast",function(){delete a[h];STUDIP.PersonalNotifications.update();e(this).remove()})}}})},update:function(){var i=_.values(a).length,g=parseInt(e("#notification_marker").text(),10),h=0;e("#notification_list > ul > li").each(function(){if(parseInt(e(this).data("timestamp"),10)>parseInt(e("#notification_marker").data("lastvisit"),10)){h+=1}});if(h>0){e("#notification_marker").data("seen",false).addClass("alert");window.document.title="(!) "+d}else{e("#notification_marker").removeClass("alert");window.document.title=d}if(i){e("#notification_container").addClass("hoverable");if(i>g&&c!==false){c.play()}}else{e("#notification_container").removeClass("hoverable")}if(g!==i){e("#notification_marker").text(i);Notificon(i||"",{favicon:b})}},isVisited:function(){var g=this.id;e.each(a,function(h,i){if(i.html_id===g){STUDIP.PersonalNotifications.sendReadInfo(i.personal_notification_id);delete a[h];jQuery(".notification[data-id="+i.personal_notification_id+"]").fadeOut(function(){jQuery(this).remove()});directlydeleted.push(i.personal_notification_id);STUDIP.PersonalNotifications.update()}})},setSeen:function(){if(e("#notification_marker").data("seen")){return}e("#notification_marker").data("seen",true);e.ajax({url:STUDIP.ABSOLUTE_URI_STUDIP+"dispatch.php/jsupdater/notifications_seen",success:function(g){e("#notification_marker").removeClass("alert").data("lastvisit",g)}})}};e(document).on("click","#notification_list .mark_as_read",STUDIP.PersonalNotifications.markAsRead);e(document).on("mouseenter","#notification_list",STUDIP.PersonalNotifications.setSeen);e(document).ready(function(){if(e("#notification_marker").length>0){d=window.document.title;b=e('link[rel="shortcut icon"]').attr("href");STUDIP.PersonalNotifications.newNotifications=f;if(e("#audio_notification").length>0){c=e("#audio_notification").get(0);c.load()}}})}(jQuery));